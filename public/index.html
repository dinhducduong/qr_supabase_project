<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QR Scanner - ƒê√≥ng H√†ng</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm" type="module"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f1f5f9;
      color: #1e293b;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }

    h1 {
      margin-top: 40px;
      font-size: 24px;
      color: #0f172a;
    }

    #reader {
      width: 300px;
      margin-top: 20px;
      border: 2px dashed #64748b;
      border-radius: 12px;
      padding: 10px;
      background-color: #fff;
    }

    button {
      margin-top: 20px;
      padding: 12px 24px;
      font-size: 16px;
      background-color: #3b82f6;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #2563eb;
    }

    button:disabled {
      background-color: #94a3b8;
      cursor: not-allowed;
    }

    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }

    audio {
      display: none;
    }
  </style>
</head>

<body>
  <h1>üì¶ Qu√©t m√£ QR ƒë·ªÉ ƒë√≥ng h√†ng</h1>

  <div id="reader"></div>

  <div class="button-group">
    <button id="startBtn">üîç B·∫Øt ƒë·∫ßu qu√©t m√£</button>
    <button id="retryBtn" style="display:none;">üîÅ Qu√©t l·∫°i</button>
    <button id="nextBtn" style="display:none;">‚û°Ô∏è ƒê∆°n h√†ng ti·∫øp theo</button>
  </div>

  <audio id="startAudio" src="./bat-dau-dong-hang.mp3"></audio>
  <audio id="beepAudio" src="./tieng_bip_mot_tieng.mp3"></audio>

  <script>
    let html5QrCode;
    let currentCode = "";
    let startTime = "";
    const startAudio = document.getElementById("startAudio");
    const beepAudio = document.getElementById("beepAudio");
    const API_URL = 'https://qrscan-0531.restdb.io/rest/scans';
    const API_KEY = '551971c5d04eb9bd3c25ea6c088b2016cb8db';
    document.getElementById("startBtn").addEventListener("click", async () => {
      html5QrCode = new Html5Qrcode("reader");
      const devices = await Html5Qrcode.getCameras();
      const backCamera = devices.find(d => d.label.toLowerCase().includes('back')) || devices[0];

      html5QrCode.start(
        backCamera.id,
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          if (qrCodeMessage !== currentCode) {
            currentCode = qrCodeMessage;
            beepAudio.play();
            startAudio.play();
            startTime = new Date().toISOString();
            document.getElementById("retryBtn").style.display = "inline-block";
            document.getElementById("nextBtn").style.display = "inline-block";
            html5QrCode.stop();
            fetch(API_URL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-apikey': API_KEY,
                'cache-control': 'no-cache'
              },
              body: JSON.stringify({
                code: currentCode,
                start_time: startTime,
                stop_time: null
              })
            })
              .then(res => res.json())
              .then(data => console.log("‚úÖ L∆∞u th√†nh c√¥ng:", data))
              .catch(err => console.error("‚ùå L·ªói l∆∞u:", err));
          }
        },
        errorMessage => {
          // optional: handle scan errors
        }
      );
    });

    document.getElementById("retryBtn").addEventListener("click", () => {
      const pauseTime = new Date().toISOString();
      fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-apikey': API_KEY,
          'cache-control': 'no-cache'
        },
        body: JSON.stringify({
          qr_code: currentCode,
          start_time,
          pause_time: new Date().toISOString()
        })
      })
        .then(res => res.json())
        .then(data => console.log("‚úÖ T·∫°m d·ª´ng:", data))
        .catch(err => console.error("‚ùå L·ªói:", err));
      currentCode = "";
      startTime = "";
      document.getElementById("retryBtn").style.display = "none";
      document.getElementById("nextBtn").style.display = "none";
    });

    document.getElementById("nextBtn").addEventListener("click", () => {
      currentCode = "";
      startTime = "";
      document.getElementById("retryBtn").style.display = "none";
      document.getElementById("nextBtn").style.display = "none";
    });
  </script>
</body>

</html>